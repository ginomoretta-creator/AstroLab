"use strict";const o=require("electron"),g=require("child_process"),r=require("path"),b=require("fs"),P=require("url");var h=typeof document<"u"?document.currentScript:null;const l=r.dirname(P.fileURLToPath(typeof document>"u"?require("url").pathToFileURL(__filename).href:h&&h.tagName.toUpperCase()==="SCRIPT"&&h.src||new URL("main.js",document.baseURI).href));let a=null;const f=8080;let e=null;const u=!o.app.isPackaged;function t(n){console.log(`[ASL-Sandbox] ${n}`),e==null||e.webContents.executeJavaScript(`console.log('[Main] ${n.replace(/'/g,"\\'")}')`).catch(()=>{})}function m(){t(`isDev: ${u}`),t(`__dirname: ${l}`);const n=u?r.join(l,"../resources"):process.resourcesPath;t(`resourcesPath: ${n}`);const s=r.join(n,"backend","asl-sandbox-backend.exe");if(t(`Looking for bundled backend at: ${s}`),b.existsSync(s))return t("✅ Found bundled Python backend"),{executable:s,args:["--host","127.0.0.1","--port",f.toString()],cwd:r.dirname(s),found:!0};t("❌ Bundled backend not found");const d=u?r.join(l,"../.."):r.join(n,"../.."),i=r.join(d,"THRML-Sandbox","backend");return t(`Looking for dev backend at: ${i}`),b.existsSync(r.join(i,"server.py"))?(t("✅ Found development Python backend"),{executable:"python",args:["-m","uvicorn","server:app","--host","127.0.0.1","--port",f.toString()],cwd:i,found:!0}):(t("❌ No backend found!"),{executable:"",args:[],cwd:"",found:!1})}function w(){e=new o.BrowserWindow({width:1400,height:900,minWidth:1200,minHeight:700,frame:!1,backgroundColor:"#0a0a0f",webPreferences:{preload:r.join(l,"preload.js"),nodeIntegration:!1,contextIsolation:!0},show:!1}),e.once("ready-to-show",()=>{e==null||e.show()}),u?(e.loadURL("http://localhost:5173"),e.webContents.openDevTools({mode:"detach"})):e.loadFile(r.join(l,"../dist/index.html")),e.webContents.setWindowOpenHandler(({url:n})=>(o.shell.openExternal(n),{action:"deny"})),e.on("closed",()=>{e=null})}function y(){var s,d;const n=m();if(!n.found){t("Cannot start backend - no backend found");return}t("Starting Python backend..."),t(`Executable: ${n.executable}`),t(`Args: ${n.args.join(" ")}`),t(`CWD: ${n.cwd}`);try{const i=!n.executable.endsWith(".exe");a=g.spawn(n.executable,n.args,{cwd:n.cwd,shell:i,detached:!1,windowsHide:!0,env:{...process.env,PYTHONUNBUFFERED:"1"},stdio:["pipe","pipe","pipe"]}),(s=a.stdout)==null||s.on("data",c=>{const p=c.toString().trim();p&&t(`Backend stdout: ${p}`)}),(d=a.stderr)==null||d.on("data",c=>{const p=c.toString().trim();p&&t(`Backend stderr: ${p}`)}),a.on("error",c=>{t(`Backend spawn error: ${c.message}`)}),a.on("close",c=>{t(`Backend exited with code ${c}`),a=null}),t(`Backend process started with PID: ${a.pid}`)}catch(i){t(`Failed to spawn backend: ${i.message}`)}}function k(){if(a){if(t("Stopping Python backend..."),process.platform==="win32"&&a.pid)try{g.spawn("taskkill",["/pid",a.pid.toString(),"/f","/t"],{shell:!0})}catch{a.kill()}else a.kill("SIGTERM");a=null}}async function x(){try{return(await fetch(`http://127.0.0.1:${f}/`,{signal:AbortSignal.timeout(2e3)})).ok}catch{return!1}}o.ipcMain.handle("window:minimize",()=>{e==null||e.minimize()});o.ipcMain.handle("window:maximize",()=>{e!=null&&e.isMaximized()?e.unmaximize():e==null||e.maximize()});o.ipcMain.handle("window:close",()=>{e==null||e.close()});o.ipcMain.handle("backend:status",async()=>{if(await x())try{return{status:"online",data:await(await fetch(`http://127.0.0.1:${f}/`)).json()}}catch{return{status:"online",data:{}}}return{status:"offline",error:"Backend not responding"}});o.ipcMain.handle("backend:port",()=>f);o.ipcMain.handle("backend:restart",async()=>(k(),await new Promise(n=>setTimeout(n,1e3)),y(),{status:"restarting"}));o.ipcMain.handle("backend:debug",()=>{const n=m();return{isDev:u,resourcesPath:u?r.join(l,"../resources"):process.resourcesPath,...n,processRunning:a!==null,processPid:a==null?void 0:a.pid}});o.app.whenReady().then(async()=>{t("App ready, starting backend..."),y();let n=0;const s=30;for(;n<s;){if(await x()){t("Backend is ready!");break}await new Promise(i=>setTimeout(i,500)),n++,n%5===0&&t(`Still waiting for backend... (${n}/${s})`)}n>=s&&t("Backend did not start in time"),w(),o.app.on("activate",()=>{o.BrowserWindow.getAllWindows().length===0&&w()})});o.app.on("window-all-closed",()=>{k(),process.platform!=="darwin"&&o.app.quit()});o.app.on("before-quit",()=>{k()});const S=o.app.requestSingleInstanceLock();S?o.app.on("second-instance",()=>{e&&(e.isMinimized()&&e.restore(),e.focus())}):o.app.quit();
